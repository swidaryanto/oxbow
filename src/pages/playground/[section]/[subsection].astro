---
import type { ImageMetadata } from "astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Text from "@/components/fundations/typography/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";

import SubsectionToolbarIsland from "@/components/playground/SubsectionToolbarIsland";
import { formatDistanceToNowStrict } from "date-fns";
import updates from "@/data/updates.json";

export async function getStaticPaths() {
  // Get all oxbow components
  const modules = import.meta.glob("@/components/oxbow/**/*.astro");
  const keys = Object.keys(modules);
  
  // Build paths for all section/subsection combinations
  const paths = [];
  const seen = new Set();
  
  for (const key of keys) {
    // Extract section and subsection from the path
    const pathParts = key
      .replace(/^.*?\/src\/components\/oxbow\//, "")
      .replace(/\.astro$/, "")
      .split("/");
    
    if (pathParts.length >= 2) {
      const section = pathParts[0];
      const subsection = pathParts[1];
      const pathKey = `${section}/${subsection}`;
      
      if (!seen.has(pathKey)) {
        seen.add(pathKey);
        paths.push({
          params: { section, subsection },
        });
      }
    }
  }
  
  return paths;
}

const { section, subsection } = Astro.params;
const modules = import.meta.glob("@/components/oxbow/**/*.astro", {
  eager: true,
});
const keys = Object.keys(modules);
const sectionRegex = new RegExp(`${section}/${subsection}/.+\\.astro$`, "i");
// Build category → blocks map from available components
const triples = keys.map((k) => k.split("/").slice(-3)); // [section, subsection, file]
const subsByCat = Object.fromEntries(
  Array.from(new Set(triples.map(([sec]) => sec))).map((sec) => {
    const subs = Array.from(
      new Set(triples.filter(([s]) => s === sec).map(([, sub]) => sub))
    ).sort();
    return [sec, subs];
  })
);
const sectionComponents = keys
  .filter((k) => k.match(sectionRegex))
  .sort()
  .map((k) => {
    const filePath = k.split("/").slice(-3).join("/");
    const imagePath = `/src/screenshots/${k
      .split("/")
      .slice(-3)
      .join("_")
      .replace(".astro", ".png")}`;
    const mod: any = (modules as any)[k] || {};
    return {
      key: k,
      filePath,
      imagePath,
      description: mod.description || "",
      free: !!mod.freeComponent,
      component: mod?.default,
    };
  });
const allSmall = sectionComponents.every(({ filePath }) => {
  const pathNoAstro = filePath.replace(".astro", "");
  return /\/(buttons|button-groups|button-icon|badges|breadcrumbs|checkboxes|inputs|input-groups|radiogroups|select|toggles|typography|flyouts|alerts|avatars|banners)\//i.test(
    pathNoAstro
  );
});
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/screenshots/*.png",
  { eager: true }
);
const formattedSubsection = subsection.replace("-", " ");

const SEVEN_DAYS_AGO = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
// Normalize subsection for lookup (keeps things case/char safe)
const subsectionKey = (subsection || "").toLowerCase();
---

<style>
  .masonry-grid {
    column-gap: 1rem;
  }
  .masonry-item {
    break-inside: avoid;
    margin-bottom: 1rem;
  }
  /* Responsive column count */ /* sm ≥ 640px */
  @media (min-width: 640px) {
    .masonry-grid {
      column-count: 2;
    }
  }
  /* md ≥ 768px */
  @media (min-width: 768px) {
    .masonry-grid {
      column-count: 2;
    }
  }
  /* lg ≥ 1024px */
  @media (min-width: 1024px) {
    .masonry-grid {
      column-count: 3;
    }
  }
  /* xl ≥ 1280px */
  @media (min-width: 1280px) {
    .masonry-grid {
      column-count: 3;
    }
  }
  /* custom ≥ 1400px */
  @media (min-width: 1400px) {
    .masonry-grid {
      column-count: 4;
    }
  }
  /* 2xl ≥ 1536px */
  @media (min-width: 1536px) {
    .masonry-grid {
      column-count: 4;
    }
  }
  /* 3xl ≥ 1920px (custom bigger breakpoint) */
  @media (min-width: 1920px) {
    .masonry-grid {
      column-count: 2;
    }
  }
  @media (max-width: 767px) {
    .masonry-grid {
      column-count: 1;
    }
  }
</style>
<BaseLayout>
  <section
    x-data={`{ layout: 'grid', cat: '${section}', sub: '${subsection}', subs: {}, fmt(s){ return (s||'').replace(/-/g,' ').replace(/\b\w/g, c => c.toUpperCase()); } }`}
    x-init="subs = JSON.parse($el.dataset.subs || '{}')"
    data-subs={JSON.stringify(subsByCat)}
  >
    <Wrapper variant="standard" class="pt-8 pb-4">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <Text
          tag="h1"
          variant="textXL"
          class="font-semibold tracking-tight capitalize text-base-900 dark:text-base-50"
        >
          {subsection.replace(/-/g, " ")}
        </Text>
        <div>
          <SubsectionToolbarIsland
            client:load
            cat={section}
            sub={subsection}
            subsByCat={subsByCat}
          />
        </div>
      </div>
    </Wrapper>
    <Wrapper variant="standard" class="border-y py-8">
      <div class="masonry-grid">
        {
          sectionComponents.map(
            (
              { key, filePath, imagePath, description, free, component: C },
              index
            ) => {
              const pathNoAstro = filePath.replace(".astro", "");
              const screenshot = images[imagePath]?.default;
              if (!screenshot) return null;
              const updatedAt = new Date(updates[filePath] * 1000);
              const isUpdatedLastWeek = updatedAt > SEVEN_DAYS_AGO;
              return (
                <a
                  href={`/playground/${pathNoAstro}`}
                  class="relative flex flex-col group masonry-item"
                  style="display: block;"
                >
                  <div class="flex flex-col sr-only gap-1">
                    {isUpdatedLastWeek && (
                      <Text
                        tag="p"
                        variant="textXS"
                        class="relative flex items-center gap-1 text-base-400 dark:text-base-500"
                      >
                        Updated{" "}
                        {formatDistanceToNowStrict(updatedAt, {
                          unit: "day",
                          roundingMethod: "ceil",
                        })}{" "}
                        ago
                      </Text>
                    )}
                  </div>
                  <div class="overflow-hidden bg-white outline outline-base-200 dark:outline-base-800 ">
                    <img
                      width={screenshot.width ?? 1000}
                      height={screenshot.height ?? 1000}
                      src={screenshot.src}
                      alt={`${subsection} preview ${index + 1}`}
                      class="object-cover object-top"
                      loading="lazy"
                    />
                  </div>
                </a>
              );
            }
          )
        }
      </div>
    </Wrapper>
  </section>
</BaseLayout>

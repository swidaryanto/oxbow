---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import Text from "@/components/fundations/typography/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
import Cross from "@/components/assets/Cross.astro";
import StripesBG from "@/components/assets/StripesBG.astro";
import ChangelogCard from "@/components/changelog/ChangelogCard.astro";

// Load all changelog entries from content collection
const raw = await getCollection("changelog");

// Render and extract excerpt from each entry
const entries = await Promise.all(
  raw.map(async (entry) => {
    const { Content } = await entry.render();
    // Extract first paragraph as excerpt by rendering to string
    // This is a simplified approach - in production you might want a dedicated excerpt field
    return {
      ...entry,
      excerpt: entry.body.split("\n\n")[0]?.substring(0, 200) || "",
    };
  })
);

// Sort latest first
entries.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);
---

<BaseLayout>
  <Wrapper variant="standard" class="pt-32 pb-12 relative overflow-hidden">
    <StripesBG
      variant="light"
      direction="horizontal"
      class="absolute hidden md:block inset-0 w-[25%] -mx-px h-[60%] top-0 ml-auto"
    />
    <StripesBG
      variant="secondary"
      direction="horizontal"
      class="absolute hidden md:block w-[25%] -mx-px h-[15%] top-[60%] right-0"
    />
    <StripesBG
      variant="base"
      direction="horizontal"
      class="absolute hidden md:block w-[25%] -mx-px top-[77%] -bottom-0 right-0"
    />

    <div class="text-balance max-w-xl relative">
      <Text
        tag="h1"
        variant="displayMD"
        class="font-medium tracking-tight text-base-600 dark:text-white"
      >
        Changelog
      </Text>
      <Text
        tag="p"
        variant="textBase"
        class="mt-4 text-base-500 dark:text-base-400"
      >
        New features, improvements, and bugs we sent to the shadow realm. All
        tracked right here.
      </Text>
    </div>
  </Wrapper>
  <Wrapper
    variant="paddingless"
    class="border-y border-base-200 dark:border-base-800 lg:border-x"
  >
    <div
      class="flex flex-col gap-px divide-y divide-base-200 dark:divide-base-800"
    >
      {entries.map((entry) => <ChangelogCard entry={entry} />)}
    </div>
  </Wrapper>
</BaseLayout>
